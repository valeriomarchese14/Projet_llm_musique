import miditoolkit
import os
from tqdm import tqdm

dossier_entree = "Projet_llm_musique/GrandMidiPiano/test"
dossier_sortie = "Projet_llm_musique/dataset_tokens2"

os.makedirs(dossier_sortie, exist_ok=True)
fichiers_midi = [f for f in os.listdir(dossier_entree) if f.endswith(('.mid', '.midi'))]

for nom_fichier in tqdm(fichiers_midi, desc="Tokenisation"):
    chemin_complet = os.path.join(dossier_entree, nom_fichier)
    try:
        midi = miditoolkit.MidiFile(chemin_complet)
        
        toutes_les_notes = []
        for inst in midi.instruments:
            toutes_les_notes.extend(inst.notes)
            
        toutes_les_notes.sort(key=lambda x: x.start)
        
        tokens = []
        last_start = 0  

        for note in toutes_les_notes:
            delta = note.start - last_start
            tokens.append(f"TIME_SHIFT_{delta}")
            last_start = note.start 

            tokens.append(f"NOTE_ON_{note.pitch}")
            tokens.append(f"DURATION/10_{(note.end - note.start)//10}\n")
            

        nom_sortie = os.path.splitext(nom_fichier)[0] + ".txt"
        chemin_sortie = os.path.join(dossier_sortie, nom_sortie)
        
        with open(chemin_sortie, "w", encoding="utf-8") as f:
            f.write(" ".join(tokens))
            
    except Exception as e:
        print(f"Erreur sur le fichier {nom_fichier}: {e}")

